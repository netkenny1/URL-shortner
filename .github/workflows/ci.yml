name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: Run Tests and Coverage
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP with Xdebug
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: pdo_sqlite, xdebug
          coverage: xdebug
      
      - name: Verify Xdebug coverage mode
        run: |
          php -v
          php -m | grep -i xdebug || echo "WARNING: Xdebug not found"
          php -r "echo 'Xdebug loaded: ' . (extension_loaded('xdebug') ? 'YES' : 'NO') . PHP_EOL;"
          php -r "echo 'Xdebug mode: ' . ini_get('xdebug.mode') . PHP_EOL;"
      
      - name: Install dependencies
        run: |
          if [ -f composer.json ]; then
            composer install --prefer-dist --no-progress --no-interaction
          else
            echo "composer.json not found!"
            exit 1
          fi
      
      - name: Run PHP syntax check
        run: |
          echo "Checking PHP syntax..."
          ERROR_COUNT=0
          while IFS= read -r file; do
            if ! php -l "$file" 2>&1; then
              ERROR_COUNT=$((ERROR_COUNT + 1))
            fi
          done < <(find . -name "*.php" -not -path "./vendor/*" -not -path "./tests/*")
          if [ $ERROR_COUNT -gt 0 ]; then
            echo "Found $ERROR_COUNT syntax errors!"
            exit 1
          fi
          echo "✅ Syntax check passed"
      
      - name: Prepare coverage directory
        run: |
          mkdir -p coverage
          chmod -R 0777 coverage
      
      - name: Debug PHP & PHPUnit
        run: |
          php -v
          php -m | grep -i xdebug || true
          php -r "echo 'Xdebug loaded: ' . (extension_loaded('xdebug') ? 'YES' : 'NO') . PHP_EOL;"
          php -r "echo 'Xdebug mode: ' . ini_get('xdebug.mode') . PHP_EOL;"
          ./vendor/bin/phpunit --version
      
      - name: Run tests
        run: |
          echo "Running tests..."
          ./vendor/bin/phpunit
          echo "✅ Tests passed!"
      
      - name: Generate coverage (optional)
        continue-on-error: true
        env:
          XDEBUG_MODE: coverage
        run: |
          echo "Attempting to generate coverage..."
          XDEBUG_MODE=coverage ./vendor/bin/phpunit --coverage-text --coverage-clover coverage/clover.xml || true
          if [ -f coverage/clover.xml ]; then
            echo "✅ Coverage generated!"
          else
            echo "⚠️ Coverage not generated (non-blocking)"
          fi
      
      - name: Check coverage threshold (optional)
        continue-on-error: true
        run: |
          if [ ! -f coverage/clover.xml ]; then
            echo "⚠️ Coverage file not found - skipping threshold check"
            exit 0
          fi
          
          COVERAGE=$(php -r "
            \$xml = @simplexml_load_file('coverage/clover.xml');
            if (\$xml === false) { echo '0'; exit(0); }
            \$metrics = \$xml->project->metrics;
            \$statements = (int)\$metrics['statements'];
            \$covered = (int)\$metrics['coveredstatements'];
            if (\$statements > 0) {
              echo number_format((\$covered / \$statements) * 100, 2);
            } else { echo '0'; }
          " 2>&1)
          
          echo "Code coverage: ${COVERAGE}%"
      
      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: coverage/
          retention-days: 30
      
      - name: Build Docker image
        run: |
          docker build -t shortkenny:test .
      
      - name: Test Docker image
        run: |
          docker run -d --name test-container -p 8080:80 shortkenny:test
          sleep 10
          curl -f http://localhost:8080/health || exit 1
          curl -f http://localhost:8080/metrics || exit 1
          docker stop test-container
          docker rm test-container
