name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: Run Tests and Coverage
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: pdo_sqlite
          coverage: pcov
      
      - name: Verify coverage driver is enabled
        run: |
          php -m | grep -i pcov || php -m | grep -i xdebug || echo "WARNING: Coverage driver not found"
          if php -m | grep -qi pcov; then
            echo "✅ PCOV is loaded"
            php -r "echo 'PCOV version: ' . phpversion('pcov') . PHP_EOL;"
          elif php -m | grep -qi xdebug; then
            echo "✅ Xdebug is loaded"
            php -r "echo 'Xdebug version: ' . phpversion('xdebug') . PHP_EOL;"
          fi
      
      - name: Install dependencies
        run: |
          if [ -f composer.json ]; then
            composer install --prefer-dist --no-progress --no-interaction
          else
            echo "composer.json not found!"
            exit 1
          fi
      
      - name: Run PHP syntax check
        run: |
          echo "Checking PHP syntax..."
          ERROR_COUNT=0
          while IFS= read -r file; do
            if ! php -l "$file" 2>&1; then
              ERROR_COUNT=$((ERROR_COUNT + 1))
            fi
          done < <(find . -name "*.php" -not -path "./vendor/*" -not -path "./tests/*")
          if [ $ERROR_COUNT -gt 0 ]; then
            echo "Found $ERROR_COUNT syntax errors!"
            exit 1
          fi
          echo "✅ Syntax check passed"
      
      - name: Run tests with coverage
        run: |
          mkdir -p coverage
          if [ ! -f ./vendor/bin/phpunit ]; then
            echo "PHPUnit not found! Installing..."
            composer install --prefer-dist --no-progress --no-interaction
          fi
          
          echo "Running tests with coverage..."
          # PHPUnit 10: Removed coverage config from phpunit.xml
          # Using only command-line flags with explicit filter paths
          echo "Generating coverage with explicit filter..."
          ./vendor/bin/phpunit \
            --coverage-clover=coverage/clover.xml \
            --coverage-html=coverage/html \
            --coverage-text=coverage/coverage.txt \
            --coverage-filter=src \
            --coverage-filter=api.php \
            --coverage-filter=redirect.php \
            --coverage-filter=lib.php
          
          echo "PHPUnit exit code: $?"
          echo "Files in coverage directory:"
          ls -la coverage/ 2>&1 || echo "Coverage directory doesn't exist"
          
          echo "Checking if coverage files were generated..."
          ls -la coverage/ || echo "Coverage directory is empty"
          
          if [ ! -f coverage/clover.xml ]; then
            echo "ERROR: Coverage file was not generated!"
            echo "Checking PHPUnit version and coverage support..."
            ./vendor/bin/phpunit --version
            if php -m | grep -qi pcov; then
              php -r "echo 'PCOV loaded: YES, version: ' . phpversion('pcov') . PHP_EOL;"
            elif php -m | grep -qi xdebug; then
              php -r "echo 'Xdebug loaded: YES, version: ' . phpversion('xdebug') . PHP_EOL;"
            else
              echo "No coverage driver loaded!"
            fi
            
            echo "Attempting to generate coverage with verbose output..."
            ./vendor/bin/phpunit --coverage-clover=coverage/clover.xml --verbose 2>&1 | head -50
            
            echo "Attempting to run tests without coverage to verify tests pass..."
            ./vendor/bin/phpunit
            exit 1
          fi
          
          echo "✅ Coverage file generated successfully"
          echo "Coverage file size: $(stat -f%z coverage/clover.xml 2>/dev/null || stat -c%s coverage/clover.xml 2>/dev/null || echo 'unknown') bytes"
      
      - name: Check coverage threshold
        run: |
          if [ ! -f coverage/clover.xml ]; then
            echo "ERROR: Coverage file not found at coverage/clover.xml"
            echo "Listing coverage directory:"
            ls -la coverage/ || echo "Coverage directory does not exist"
            exit 1
          fi
          
          COVERAGE=$(php -r "
            \$xml = @simplexml_load_file('coverage/clover.xml');
            if (\$xml === false) {
              echo 'ERROR: Failed to parse clover.xml';
              exit(1);
            }
            \$metrics = \$xml->project->metrics;
            \$statements = (int)\$metrics['statements'];
            \$covered = (int)\$metrics['coveredstatements'];
            if (\$statements > 0) {
              \$coverage = (\$covered / \$statements) * 100;
              echo number_format(\$coverage, 2);
            } else {
              echo '0';
            }
          " 2>&1)
          
          if [ $? -ne 0 ]; then
            echo "ERROR: Failed to calculate coverage"
            echo "$COVERAGE"
            exit 1
          fi
          
          echo "Code coverage: ${COVERAGE}%"
          COVERAGE_NUM=$(echo "$COVERAGE" | sed 's/\.//' | sed 's/^0*//')
          if [ -z "$COVERAGE_NUM" ]; then
            COVERAGE_NUM=0
          fi
          if [ "$COVERAGE_NUM" -lt 7000 ]; then
            echo "ERROR: Coverage is ${COVERAGE}%, which is below 70% threshold!"
            exit 1
          fi
          echo "✅ Coverage check passed: ${COVERAGE}%"
      
      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: coverage/
          retention-days: 30
      
      - name: Build Docker image
        run: |
          docker build -t shortkenny:test .
      
      - name: Test Docker image
        run: |
          docker run -d --name test-container -p 8080:80 shortkenny:test
          sleep 10
          curl -f http://localhost:8080/health || exit 1
          curl -f http://localhost:8080/metrics || exit 1
          docker stop test-container
          docker rm test-container
